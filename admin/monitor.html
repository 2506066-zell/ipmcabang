<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Monitor Dashboard</title>
    <link rel="icon" href="/ipm%20(2).png">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-standalone">
    <main class="admin-standalone-main">
        <section class="admin-page-head monitor-header-row">
            <div>
                <h1><i class="fas fa-server"></i> Serverless Monitor</h1>
                <p>Pantau health check endpoint dan status routing untuk operasional harian.</p>
                <p class="small"><a href="admin.html">Kembali ke Portal Admin</a></p>
            </div>
            <button class="btn btn-primary" onclick="runChecks()"><i class="fas fa-sync"></i> Refresh Data</button>
        </section>

        <section class="monitor-grid">
            <article class="admin-card">
                <h3 class="section-card-title section-title-icon"><i class="fas fa-heartbeat"></i> System Health</h3>
                <div id="health-status" class="monitor-metric">...</div>
                <div class="small muted">API Response Time</div>
                <div id="health-details" class="state-box mt-12"></div>
            </article>

            <article class="admin-card">
                <h3 class="section-card-title section-title-icon"><i class="fas fa-lock"></i> Auth Handler</h3>
                <div class="small muted mb-12">Consolidated endpoint health check</div>
                <table id="auth-table" class="monitor-table">
                    <thead><tr><th>Action</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody><tr><td colspan="3">Waiting...</td></tr></tbody>
                </table>
            </article>

            <article class="admin-card">
                <h3 class="section-card-title section-title-icon"><i class="fas fa-cubes"></i> Function Count</h3>
                <div class="monitor-metric">6 / 12</div>
                <div class="small muted">Active Serverless Functions</div>
                <div class="state-box mt-12">
                    Consolidated: 2<br>Standalone: 4<br>Status: <strong>OPTIMAL</strong>
                </div>
            </article>
        </section>
    </main>

    <script>
        const ENDPOINTS = [
            { name: 'Health', url: '/api/health', method: 'GET' },
            { name: 'DB Connection', url: '/api/dbHealth', method: 'GET' },
            { name: 'Questions', url: '/api/questions?mode=summary', method: 'GET' }
        ];

        const AUTH_CHECKS = [
            { action: 'login', method: 'POST', body: {} }, // Should 400
            { action: 'register', method: 'POST', body: {} }, // Should 400
            { action: 'promoteAdmin', method: 'POST', body: {} } // Should 400
        ];

        async function check(url, method = 'GET', body = null) {
            const start = performance.now();
            try {
                const opts = { method };
                if (body) {
                    opts.body = JSON.stringify(body);
                    opts.headers = { 'Content-Type': 'application/json' };
                }
                const res = await fetch(url, opts);
                const time = Math.round(performance.now() - start);
                return { ok: res.ok || res.status === 400 || res.status === 401, status: res.status, time };
            } catch (e) {
                return { ok: false, status: 'ERR', time: 0, error: e.message };
            }
        }

        async function runChecks() {
            // System Health
            const health = await check('/api/health');
            const hEl = document.getElementById('health-status');
            hEl.textContent = health.ok ? `${health.time}ms` : 'ERROR';
            hEl.style.color = health.ok ? 'var(--accent-success)' : 'var(--accent-danger)';
            
            document.getElementById('health-details').innerHTML = `
                DB Check: ${(await check('/api/dbHealth')).ok ? '<span style="color:var(--accent-success)">CONNECTED</span>' : '<span style="color:var(--accent-danger)">FAILED</span>'}
            `;

            // Auth Checks
            const tbody = document.querySelector('#auth-table tbody');
            tbody.innerHTML = '';
            
            for (const checkData of AUTH_CHECKS) {
                // We check the rewritten URL
                const url = `/api/auth/${checkData.action}`;
                const res = await check(url, checkData.method, checkData.body);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${checkData.action}</td>
                    <td><span class="status-badge ${res.ok ? 'status-ok' : 'status-err'}">${res.status}</span></td>
                    <td>${res.time}ms</td>
                `;
                tbody.appendChild(tr);
            }
        }

        runChecks();
    </script>
</body>
</html>
